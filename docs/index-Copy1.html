<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Constraints UI → tensor</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#0b1020; color:#e5e7eb; }
    header { padding:16px 20px; background:#111827; position:sticky; top:0; }
    h1 { font-size:18px; margin:0; }
    main { padding:20px; display:grid; gap:16px; grid-template-columns: 1fr; max-width: 900px; margin:auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { font-size:12px; color:#9ca3af; display:block; margin-bottom:6px; }
    select { width:100%; min-height:150px; background:#0b1020; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1020; border:1px solid #334155; margin:2px; font-size:12px; }
    button { background:#2563eb; color:white; border:0; padding:8px 10px; border-radius:10px; cursor:pointer; }
    button.secondary { background:#0b1020; color:#e5e7eb; border:1px solid #334155; }
    .muted { color:#9ca3af; font-size:12px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .log { font-family: ui-monospace, monospace; font-size:12px; background:#0b1020; border:1px dashed #334155; padding:8px; border-radius:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
<header>
  <h1>Constraint-UI → nåbarhet vs. gyldighet</h1>
</header>

<main>
  <section class="card">
    <!-- Kategori + forfatter -->
    <div class="row">
      <div>
        <label>Kategori (multivalg)</label>
        <select id="catSelect" multiple></select>
      </div>
      <div>
        <label>Forfatter (multivalg)</label>
        <select id="authSelect" multiple></select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Valgte kategorier:</div>
      <div id="catPills"></div>
      <div class="muted" style="margin-top:6px;">Valgte forfattere:</div>
      <div id="authPills"></div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <button id="resetBtn" class="secondary">Reset</button>
      <button id="installBtn" style="display:none;">Installer PWA</button>
    </div>
  </section>

  <!-- Korpusbygging -->
  <section class="card">
    <h2 style="font-size:14px;margin:0 0 8px 0;">Korpusbygger (union-modus)</h2>
    <div class="grid2">
      <button id="addSubcorpusBtn">Legg til delkorpus</button>
      <button id="unionBtn" class="secondary">Union delkorpus</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      Bygg delkorpuser uavhengig av nåbarhet, og ta union — demonstrerer forskjellen mellom lokal generering og global validering.
    </div>
    <div id="subcorpora" style="margin-top:8px;"></div>
    <div class="muted" style="margin-top:8px;">Union-resultat:</div>
    <div id="unionOut" class="log"></div>
  </section>

  <!-- Logg -->
  <section class="card">
    <h2 style="font-size:14px;margin:0 0 8px 0;">Logg</h2>
    <div id="log" class="log"></div>
  </section>
</main>

<script>
/**
 * Minimal demo-datasett som utløser den interessante logikken.
 */
const DATA = {
  authors: {
    "Ibsen": ["dramatikk"],
    "Rabbe": ["barnebok"],
    "Løland": ["barnebok", "dramatikk"],  // broen → ekstra dimensjon
    "Prøysen": ["barnebok"],
    "Fosse": ["dramatikk"]
  },
  categories: ["barnebok", "dramatikk", "roman", "sakprosa"]
};

const catSelect = document.getElementById("catSelect");
const authSelect = document.getElementById("authSelect");
const catPills = document.getElementById("catPills");
const authPills = document.getElementById("authPills");
const logEl = document.getElementById("log");

let selectedCats = new Set();
let selectedAuthors = new Set();

const authorCats = (a) => new Set(DATA.authors[a] || []);
const unionSet = (sets) => {
  const u = new Set();
  sets.forEach(s => s.forEach(x => u.add(x)));
  return u;
};

function log(msg) {
  logEl.textContent = msg + "\n\n" + logEl.textContent;
}

function renderPills() {
  catPills.innerHTML = [...selectedCats].map(c => `<span class="pill">${c}</span>`).join("");
  authPills.innerHTML = [...selectedAuthors].map(a => `<span class="pill">${a}</span>`).join("");
}

function rebuildOptions() {
  let allowedCats;
  if (selectedAuthors.size === 0) {
    allowedCats = new Set(DATA.categories);
  } else {
    const sets = [...selectedAuthors].map(a => authorCats(a));
    allowedCats = unionSet(sets);
  }

  let allowedAuthors;
  if (selectedCats.size === 0) {
    allowedAuthors = new Set(Object.keys(DATA.authors));
  } else {
    allowedAuthors = new Set();
    for (const a of Object.keys(DATA.authors)) {
      const cats = authorCats(a);
      let ok = false;
      for (const c of selectedCats) if (cats.has(c)) ok = true;
      if (ok) allowedAuthors.add(a);
    }
  }

  for (const c of [...selectedCats]) {
    if (!allowedCats.has(c)) {
      selectedCats.delete(c);
      log(`Pruning: fjernet kategori "${c}" (inkonsistent med forfattervalg).`);
    }
  }

  for (const a of [...selectedAuthors]) {
    if (!allowedAuthors.has(a)) {
      selectedAuthors.delete(a);
      log(`Pruning: fjernet forfatter "${a}" (inkonsistent med kategorivalg).`);
    }
  }

  catSelect.innerHTML = "";
  for (const c of DATA.categories) {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    opt.disabled = !allowedCats.has(c);
    opt.selected = selectedCats.has(c);
    catSelect.appendChild(opt);
  }

  authSelect.innerHTML = "";
  for (const a of Object.keys(DATA.authors)) {
    const opt = document.createElement("option");
    opt.value = a;
    opt.textContent = a + " (" + [...authorCats(a)].join(", ") + ")";
    opt.disabled = !allowedAuthors.has(a);
    opt.selected = selectedAuthors.has(a);
    authSelect.appendChild(opt);
  }

  renderPills();
}

catSelect.addEventListener("change", () => {
  selectedCats = new Set([...catSelect.selectedOptions].map(o => o.value));
  log(`Valgte kategorier: ${[...selectedCats].join(", ") || "∅"}`);
  rebuildOptions();
});

authSelect.addEventListener("change", () => {
  selectedAuthors = new Set([...authSelect.selectedOptions].map(o => o.value));
  log(`Valgte forfattere: ${[...selectedAuthors].join(", ") || "∅"}`);
  rebuildOptions();
});

document.getElementById("resetBtn").addEventListener("click", () => {
  selectedCats.clear();
  selectedAuthors.clear();
  log("Reset.");
  rebuildOptions();
});

// Init
rebuildOptions();
log("Prøv: velg barnebok + dramatikk → velg Ibsen → barnebok prunes. Gå via Løland for å nå den 'utilgjengelige' gyldige tilstanden.");

// --- Korpusbygging (union-modus)
const subcorporaEl = document.getElementById("subcorpora");
const unionOutEl = document.getElementById("unionOut");
let subcorpora = [];

function renderSubcorpora() {
  subcorporaEl.innerHTML = subcorpora.map((sc, i) => `
    <div class="log" style="margin-bottom:6px;">
      #${i+1} cats=${[...sc.cats].join("|") || "∅"} ; authors=${[...sc.authors].join("|") || "∅"}
      <button data-i="${i}" class="secondary" style="float:right;margin-top:-2px;">Slett</button>
    </div>
  `).join("");

  subcorporaEl.querySelectorAll("button").forEach(b => {
    b.addEventListener("click", () => {
      subcorpora.splice(Number(b.dataset.i), 1);
      renderSubcorpora();
    });
  });
}

document.getElementById("addSubcorpusBtn").addEventListener("click", () => {
  subcorpora.push({ cats: new Set(selectedCats), authors: new Set(selectedAuthors) });
  log(`La til delkorpus #${subcorpora.length}.`);
  renderSubcorpora();
});

document.getElementById("unionBtn").addEventListener("click", () => {
  const uCats = unionSet(subcorpora.map(sc => sc.cats));
  const uAuthors = unionSet(subcorpora.map(sc => sc.authors));
  unionOutEl.textContent = `cats={${[...uCats].join(", ")}};\nauthors={${[...uAuthors].join(", ")}}`;
  log("Union bygget — slutt-evaluert global gyldighet uten begrensningen av nåbarhet.");
});

// --- PWA install prompt
let deferredPrompt = null;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";
});

installBtn.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = "none";
});

// Service worker registrering
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
